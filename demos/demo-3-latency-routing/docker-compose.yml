version: '3.8'

# OpenGSLB Demo 3: Latency-Based Routing
#
# This demo shows how OpenGSLB automatically routes traffic to the fastest
# backend based on measured health check latency.
#
# Network: 10.30.0.0/24
#   - overwatch: 10.30.0.10 (DNS + gossip receiver)
#   - webapp1:   10.30.0.21 (nginx + agent) - FAST
#   - webapp2:   10.30.0.22 (nginx + agent) - MEDIUM
#   - webapp3:   10.30.0.23 (nginx + agent) - SLOW
#   - client:    10.30.0.100 (SSH access for demo)

networks:
  demo:
    driver: bridge
    ipam:
      config:
        - subnet: 10.30.0.0/24

services:
  # ==========================================================================
  # OpenGSLB Overwatch - DNS + Gossip Receiver + Latency Measurement
  # ==========================================================================
  overwatch:
    build:
      context: .
      dockerfile: Dockerfile.overwatch
    container_name: overwatch
    hostname: overwatch
    networks:
      demo:
        ipv4_address: 10.30.0.10
    ports:
      # DNS not exposed to host - use client container for DNS queries
      - "8080:8080"   # API (for host access)
      - "9090:9090"   # Metrics (for host access)
    volumes:
      - ./bin/opengslb:/opt/opengslb/opengslb:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # ==========================================================================
  # Webapp Servers - nginx + OpenGSLB Agent + tc support for latency simulation
  # ==========================================================================
  webapp1:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: webapp1
    hostname: webapp1
    networks:
      demo:
        ipv4_address: 10.30.0.21
    cap_add:
      - NET_ADMIN    # Required for tc (traffic control)
    volumes:
      - ./bin/opengslb:/opt/opengslb/opengslb:ro
      - ./configs/agent1.yaml:/tmp/agent-config.yaml:ro
    depends_on:
      - overwatch
    restart: unless-stopped

  webapp2:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: webapp2
    hostname: webapp2
    networks:
      demo:
        ipv4_address: 10.30.0.22
    cap_add:
      - NET_ADMIN    # Required for tc (traffic control)
    volumes:
      - ./bin/opengslb:/opt/opengslb/opengslb:ro
      - ./configs/agent2.yaml:/tmp/agent-config.yaml:ro
    depends_on:
      - overwatch
    restart: unless-stopped

  webapp3:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    container_name: webapp3
    hostname: webapp3
    networks:
      demo:
        ipv4_address: 10.30.0.23
    cap_add:
      - NET_ADMIN    # Required for tc (traffic control)
    volumes:
      - ./bin/opengslb:/opt/opengslb/opengslb:ro
      - ./configs/agent3.yaml:/tmp/agent-config.yaml:ro
    depends_on:
      - overwatch
    restart: unless-stopped

  # ==========================================================================
  # Client Container - SSH access for interactive demo
  # ==========================================================================
  client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: client
    hostname: client
    networks:
      demo:
        ipv4_address: 10.30.0.100
    ports:
      - "2222:22"     # SSH access for demo
    depends_on:
      - overwatch
      - webapp1
      - webapp2
      - webapp3
    restart: unless-stopped
