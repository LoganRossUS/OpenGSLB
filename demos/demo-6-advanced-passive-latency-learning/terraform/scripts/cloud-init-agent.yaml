#cloud-config

package_update: true
package_upgrade: false

packages:
  - git
  - curl
  - jq
  - nginx
  - build-essential
  - libcap2-bin

write_files:
  - path: /etc/systemd/system/opengslb-agent.service
    permissions: '0644'
    content: |
      [Unit]
      Description=OpenGSLB Agent
      After=network.target nginx.service
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/opengslb --mode agent --config /etc/opengslb/agent.yaml
      Restart=always
      RestartSec=5
      StandardOutput=journal
      StandardError=journal
      [Install]
      WantedBy=multi-user.target

  - path: /var/www/html/index.html
    permissions: '0644'
    content: |
      <!DOCTYPE html>
      <html>
      <head><title>OpenGSLB Demo - ${region}</title></head>
      <body>
        <h1>OpenGSLB Demo Backend</h1>
        <p>Region: ${region}</p>
        <p>Server: ${hostname}</p>
        <p>This backend is part of the ADR-017 Passive Latency Learning demo.</p>
      </body>
      </html>

  - path: /opt/setup-opengslb.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -x
      exec > /var/log/opengslb-setup.log 2>&1

      echo "=== OpenGSLB Agent Setup Started at $(date) ==="
      echo "Region: ${region}"
      echo "Hostname: ${hostname}"

      # Create directories
      mkdir -p /etc/opengslb /var/log/opengslb /opt/opengslb

      # Discover the actual IP address of this VM
      MY_IP=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
      echo "Discovered IP address: $MY_IP"

      # Generate config file with actual IP address
      cat > /etc/opengslb/agent.yaml <<CONFIGEOF
mode: agent
agent:
  identity:
    service_token: "${service_token}"
    region: ${region}
  backends:
    - service: test.opengslb.local
      address: $MY_IP
      port: 80
      weight: 100
      health_check:
        type: http
        path: /
        interval: 5s
        timeout: 2s
  latency_learning:
    enabled: true
    poll_interval: 10s
    ipv4_prefix: 24
    ipv6_prefix: 48
    min_connection_age: 5s
    max_subnets: 10000
    subnet_ttl: 24h
    min_samples: 3
    report_interval: 30s
    ewma_alpha: 0.3
  gossip:
    encryption_key: "${gossip_encryption_key}"
    overwatch_nodes:
      - 10.1.1.10:7946
  heartbeat:
    interval: 10s
metrics:
  enabled: true
  address: ":9090"
logging:
  level: debug
  format: json
CONFIGEOF
      chmod 600 /etc/opengslb/agent.yaml
      echo "Config file generated with IP: $MY_IP"

      # Start nginx
      echo "Starting nginx..."
      systemctl enable nginx
      systemctl start nginx

      # Install Go via snap (more reliable than downloading tarball)
      echo "Installing Go via snap..."
      snap install go --classic

      # Wait for snap to be fully ready (can take a few seconds)
      echo "Waiting for snap to initialize..."
      for i in 1 2 3 4 5 6 7 8 9 10; do
        if [ -x /snap/bin/go ]; then
          echo "Go snap is ready"
          break
        fi
        echo "Waiting for go snap... attempt $i"
        sleep 3
      done

      # Verify go is available
      if [ ! -x /snap/bin/go ]; then
        echo "ERROR: /snap/bin/go not found after snap install"
        ls -la /snap/bin/ || echo "Cannot list /snap/bin"
        exit 1
      fi

      export PATH=$PATH:/snap/bin
      export GOPATH=/root/go
      export GOMODCACHE=/root/go/pkg/mod
      mkdir -p $GOPATH $GOMODCACHE
      echo "Go installed: $(/snap/bin/go version)"

      # Clone OpenGSLB
      echo "Cloning OpenGSLB..."
      cd /opt
      rm -rf /opt/opengslb
      git clone --depth 1 --branch "${git_branch}" "${git_repo}" /opt/opengslb
      if [ $? -ne 0 ]; then
        echo "FAILED to clone repository"
        exit 1
      fi
      echo "Clone successful"
      ls -la /opt/opengslb

      # Build OpenGSLB
      echo "Building OpenGSLB..."
      echo "Build started at $(date)"
      cd /opt/opengslb
      GOPATH=/root/go GOMODCACHE=/root/go/pkg/mod /snap/bin/go build -o /usr/local/bin/opengslb ./cmd/opengslb 2>&1
      BUILD_EXIT_CODE=$?
      echo "Build finished at $(date) with exit code: $BUILD_EXIT_CODE"

      if [ $BUILD_EXIT_CODE -ne 0 ]; then
        echo "FAILED to build OpenGSLB - exit code $BUILD_EXIT_CODE"
        exit 1
      fi

      if [ ! -f /usr/local/bin/opengslb ]; then
        echo "FAILED - binary not found at /usr/local/bin/opengslb"
        exit 1
      fi

      chmod 755 /usr/local/bin/opengslb
      echo "BUILD SUCCESS: $(ls -la /usr/local/bin/opengslb)"
      /usr/local/bin/opengslb -version || echo "Version check completed"

      # Set capabilities for reading TCP RTT
      echo "Setting capabilities..."
      setcap 'cap_net_admin=+ep' /usr/local/bin/opengslb

      # Ensure config permissions
      chmod 600 /etc/opengslb/agent.yaml

      # Start service
      echo "Starting service..."
      systemctl daemon-reload
      systemctl enable opengslb-agent
      systemctl start opengslb-agent

      sleep 3
      systemctl status opengslb-agent --no-pager

      echo "=== OpenGSLB Agent Setup Completed at $(date) ==="

runcmd:
  - [bash, /opt/setup-opengslb.sh]
