#cloud-config
# Cloud-init for OpenGSLB Agent node (Linux backend)
# This script installs nginx, Go, builds OpenGSLB from source, and starts the Agent service

package_update: true
package_upgrade: true

packages:
  - git
  - curl
  - jq
  - nginx
  - build-essential
  - libcap2-bin

write_files:
  - path: /etc/opengslb/agent.yaml
    permissions: '0600'
    content: |
      mode: agent

      identity:
        service_token: "${service_token}"
        region: ${region}

      backends:
        - service: web
          address: 0.0.0.0
          port: 80
          weight: 100
          health_check:
            type: http
            path: /
            interval: 5s
            timeout: 2s

      latency_learning:
        enabled: true
        poll_interval: 10s
        ipv4_prefix: 24
        ipv6_prefix: 48
        min_connection_age: 5s
        max_subnets: 10000
        subnet_ttl: 24h
        min_samples: 3
        report_interval: 30s
        ewma_alpha: 0.3

      gossip:
        encryption_key: "${gossip_encryption_key}"
        overwatch_nodes:
          - 10.1.1.10:7946

      heartbeat:
        interval: 10s

      metrics:
        enabled: true
        address: ":9090"

      logging:
        level: debug
        format: json

  - path: /etc/systemd/system/opengslb-agent.service
    permissions: '0644'
    content: |
      [Unit]
      Description=OpenGSLB Agent
      After=network.target nginx.service

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/opengslb --mode agent --config /etc/opengslb/agent.yaml
      Restart=always
      RestartSec=5
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  - path: /var/www/html/index.html
    permissions: '0644'
    content: |
      <!DOCTYPE html>
      <html>
      <head><title>OpenGSLB Demo - ${region}</title></head>
      <body>
        <h1>OpenGSLB Demo Backend</h1>
        <p>Region: ${region}</p>
        <p>Server: ${hostname}</p>
        <p>This backend is part of the ADR-017 Passive Latency Learning demo.</p>
      </body>
      </html>

  - path: /usr/local/bin/cloud-init-log
    permissions: '0755'
    content: |
      #!/bin/bash
      # Helper script to log cloud-init progress with timestamps
      LOG_FILE="/var/log/opengslb/cloud-init.log"
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"

runcmd:
  # Create directories
  - mkdir -p /etc/opengslb /var/log/opengslb

  # Start logging
  - /usr/local/bin/cloud-init-log "========== CLOUD-INIT STARTED =========="
  - /usr/local/bin/cloud-init-log "Node type: Agent (${region})"
  - /usr/local/bin/cloud-init-log "Hostname: ${hostname}"

  # Configure nginx
  - /usr/local/bin/cloud-init-log "Starting nginx..."
  - systemctl enable nginx
  - systemctl start nginx && /usr/local/bin/cloud-init-log "nginx started" || /usr/local/bin/cloud-init-log "FAILED to start nginx"

  # Install Go
  - /usr/local/bin/cloud-init-log "Downloading Go..."
  - curl -fsSL https://go.dev/dl/go1.23.4.linux-amd64.tar.gz -o /tmp/go.tar.gz && /usr/local/bin/cloud-init-log "Go downloaded" || /usr/local/bin/cloud-init-log "FAILED to download Go"
  - /usr/local/bin/cloud-init-log "Installing Go..."
  - rm -rf /usr/local/go && tar -C /usr/local -xzf /tmp/go.tar.gz && /usr/local/bin/cloud-init-log "Go installed" || /usr/local/bin/cloud-init-log "FAILED to install Go"
  - echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile.d/golang.sh
  - export PATH=$PATH:/usr/local/go/bin
  - /usr/local/bin/cloud-init-log "Go version: $(/usr/local/go/bin/go version)"

  # Clone OpenGSLB
  - /usr/local/bin/cloud-init-log "Cloning OpenGSLB from ${git_repo} branch ${git_branch}..."
  - git clone --depth 1 --branch ${git_branch} ${git_repo} /opt/opengslb && /usr/local/bin/cloud-init-log "Clone successful" || /usr/local/bin/cloud-init-log "FAILED to clone repository"
  - /usr/local/bin/cloud-init-log "Repository contents:" && ls -la /opt/opengslb | tee -a /var/log/opengslb/cloud-init.log

  # Build OpenGSLB
  - /usr/local/bin/cloud-init-log "Building OpenGSLB..."
  - cd /opt/opengslb && /usr/local/go/bin/go build -o /tmp/opengslb ./cmd/opengslb 2>&1 | tee -a /var/log/opengslb/cloud-init.log && /usr/local/bin/cloud-init-log "Build successful" || /usr/local/bin/cloud-init-log "FAILED to build OpenGSLB"
  - /usr/local/bin/cloud-init-log "Build output exists: $(ls -la /tmp/opengslb 2>&1)"

  # Install binary
  - /usr/local/bin/cloud-init-log "Installing binary to /usr/local/bin..."
  - sudo cp /tmp/opengslb /usr/local/bin/opengslb && /usr/local/bin/cloud-init-log "Binary copied" || /usr/local/bin/cloud-init-log "FAILED to copy binary"
  - sudo chmod 755 /usr/local/bin/opengslb && /usr/local/bin/cloud-init-log "Binary permissions set" || /usr/local/bin/cloud-init-log "FAILED to set permissions"
  - /usr/local/bin/cloud-init-log "Binary installed: $(ls -la /usr/local/bin/opengslb 2>&1)"

  # Set capabilities on the binary for CAP_NET_ADMIN (required for reading TCP RTT)
  - /usr/local/bin/cloud-init-log "Setting CAP_NET_ADMIN capability..."
  - sudo setcap 'cap_net_admin=+ep' /usr/local/bin/opengslb && /usr/local/bin/cloud-init-log "Capability set" || /usr/local/bin/cloud-init-log "FAILED to set capability"

  # Ensure config file has correct permissions
  - chmod 600 /etc/opengslb/agent.yaml
  - /usr/local/bin/cloud-init-log "Config file permissions set"

  # Enable and start the agent service
  - /usr/local/bin/cloud-init-log "Starting OpenGSLB Agent service..."
  - systemctl daemon-reload
  - systemctl enable opengslb-agent
  - systemctl start opengslb-agent && /usr/local/bin/cloud-init-log "Service started" || /usr/local/bin/cloud-init-log "FAILED to start service"

  # Check service status
  - sleep 2
  - /usr/local/bin/cloud-init-log "Service status:"
  - systemctl status opengslb-agent --no-pager 2>&1 | tee -a /var/log/opengslb/cloud-init.log

  # Log completion
  - /usr/local/bin/cloud-init-log "========== CLOUD-INIT COMPLETED =========="
  - /usr/local/bin/cloud-init-log "View logs with: cat /var/log/opengslb/cloud-init.log"
  - /usr/local/bin/cloud-init-log "View service logs with: sudo journalctl -u opengslb-agent -f"
