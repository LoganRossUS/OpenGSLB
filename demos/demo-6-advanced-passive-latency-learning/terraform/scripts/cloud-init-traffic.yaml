#cloud-config

package_update: true
package_upgrade: false

packages:
  - curl
  - dnsutils
  - jq
  - tmux
  - bc

write_files:
  - path: /usr/local/bin/generate-traffic.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Generates sustained HTTP traffic to all backends
      # Usage: generate-traffic.sh [requests_per_second] [duration_seconds]
      RPS=$${1:-1}
      DURATION=$${2:-300}
      BACKENDS=("10.2.1.10" "10.2.1.11" "10.3.1.10")
      echo "Starting traffic generation: $RPS req/s for $DURATION seconds"
      echo "Backends: $${BACKENDS[*]}"
      END_TIME=$(($(date +%s) + DURATION))
      while [ $(date +%s) -lt $END_TIME ]; do
        for backend in "$${BACKENDS[@]}"; do
          curl -s -o /dev/null -w "Backend: $backend, Time: %%{time_total}s\n" "http://$${backend}/" &
        done
        sleep $(echo "scale=3; 1/$RPS" | bc)
      done
      wait
      echo "Traffic generation complete"

  - path: /usr/local/bin/load-test.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Runs load test using hey against all backends
      # Usage: load-test.sh [total_requests] [concurrency]
      REQUESTS=$${1:-1000}
      CONCURRENCY=$${2:-10}
      BACKENDS=("10.2.1.10" "10.2.1.11" "10.3.1.10")
      echo "Starting load test: $REQUESTS requests, $CONCURRENCY concurrent"
      for backend in "$${BACKENDS[@]}"; do
        echo "Testing $backend..."
        hey -n $REQUESTS -c $CONCURRENCY "http://$${backend}/" &
      done
      wait
      echo "Load test complete"

  - path: /usr/local/bin/query-dns.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Queries DNS to test routing decisions
      # Usage: query-dns.sh [count]
      COUNT=$${1:-10}
      OVERWATCH="10.1.1.10"
      DOMAIN="web.test.opengslb.local"
      echo "Querying DNS $COUNT times for $DOMAIN"
      for i in $(seq 1 $COUNT); do
        echo "Query $i:"
        dig @$OVERWATCH $DOMAIN A +short
        sleep 1
      done

  - path: /usr/local/bin/show-latency.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Shows learned latency data from Overwatch API
      OVERWATCH="10.1.1.10"
      echo "Fetching latency table from Overwatch..."
      curl -s "http://$OVERWATCH:8080/api/v1/overwatch/latency" | jq .

  - path: /opt/setup-traffic.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -x
      exec > /var/log/traffic-setup.log 2>&1

      echo "=== Traffic Generator Setup Started at $(date) ==="
      echo "Region: ${region}"

      # Install hey (HTTP load generator)
      echo "Installing hey..."
      curl -fsSL -o /usr/local/bin/hey https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
      chmod +x /usr/local/bin/hey
      echo "hey installed: $(ls -la /usr/local/bin/hey)"

      echo ""
      echo "Available commands:"
      echo "  generate-traffic.sh [rps] [duration] - Generate sustained traffic"
      echo "  load-test.sh [requests] [concurrency] - Run load test with hey"
      echo "  query-dns.sh [count] - Query DNS for routing decisions"
      echo "  show-latency.sh - Show learned latency data"

      echo "=== Traffic Generator Setup Completed at $(date) ==="

runcmd:
  - [bash, /opt/setup-traffic.sh]
