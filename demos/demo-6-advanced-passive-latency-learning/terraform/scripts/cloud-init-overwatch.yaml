#cloud-config

package_update: true
package_upgrade: false

packages:
  - git
  - curl
  - jq
  - dnsutils
  - build-essential
  - libcap2-bin

write_files:
  - path: /etc/opengslb/overwatch.yaml
    permissions: '0600'
    content: |
      mode: overwatch
      identity:
        node_id: overwatch-eastus
        region: us-east
      dns:
        listen_address: "0.0.0.0:53"
        zones:
          - test.opengslb.local
        default_ttl: 30
      agent_tokens:
        test-backend: "${service_token}"
      gossip:
        bind_address: "0.0.0.0:7946"
        encryption_key: "${gossip_encryption_key}"
      validation:
        enabled: true
        check_interval: 30s
        check_timeout: 5s
      routing:
        default_algorithm: latency
        latency:
          method: learned
          cold_start_fallback: geo
          stale_threshold: 1h
      api:
        address: "0.0.0.0:8080"
        allowed_networks:
          - 10.0.0.0/8
      metrics:
        enabled: true
        address: "0.0.0.0:9090"
      logging:
        level: debug
        format: json

  - path: /etc/systemd/system/opengslb-overwatch.service
    permissions: '0644'
    content: |
      [Unit]
      Description=OpenGSLB Overwatch
      After=network.target
      [Service]
      Type=simple
      ExecStart=/usr/local/bin/opengslb --mode overwatch --config /etc/opengslb/overwatch.yaml
      Restart=always
      RestartSec=5
      StandardOutput=journal
      StandardError=journal
      [Install]
      WantedBy=multi-user.target

  - path: /opt/setup-opengslb.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -x
      exec > /var/log/opengslb-setup.log 2>&1

      echo "=== OpenGSLB Overwatch Setup Started at $(date) ==="

      # Create directories
      mkdir -p /etc/opengslb /var/log/opengslb /opt/opengslb

      # Stop systemd-resolved to free port 53
      echo "Stopping systemd-resolved..."
      systemctl stop systemd-resolved || true
      systemctl disable systemd-resolved || true

      # Fix DNS resolution
      rm -f /etc/resolv.conf
      echo "nameserver 8.8.8.8" > /etc/resolv.conf
      echo "nameserver 8.8.4.4" >> /etc/resolv.conf
      echo "DNS configured"

      # Wait for DNS to work
      sleep 2

      # Install Go via snap (more reliable than downloading tarball)
      echo "Installing Go via snap..."
      snap install go --classic
      export PATH=$PATH:/snap/bin
      export GOPATH=/root/go
      export GOMODCACHE=/root/go/pkg/mod
      mkdir -p $GOPATH $GOMODCACHE
      echo "Go installed: $(/snap/bin/go version)"

      # Clone OpenGSLB
      echo "Cloning OpenGSLB..."
      cd /opt
      rm -rf /opt/opengslb
      git clone --depth 1 --branch "${git_branch}" "${git_repo}" /opt/opengslb
      if [ $? -ne 0 ]; then
        echo "FAILED to clone repository"
        exit 1
      fi
      echo "Clone successful"
      ls -la /opt/opengslb

      # Build OpenGSLB
      echo "Building OpenGSLB..."
      cd /opt/opengslb
      GOPATH=/root/go GOMODCACHE=/root/go/pkg/mod /snap/bin/go build -o /usr/local/bin/opengslb ./cmd/opengslb
      if [ $? -ne 0 ]; then
        echo "FAILED to build"
        exit 1
      fi
      chmod 755 /usr/local/bin/opengslb
      echo "Build successful: $(ls -la /usr/local/bin/opengslb)"

      # Set capabilities
      echo "Setting capabilities..."
      setcap 'cap_net_bind_service=+ep' /usr/local/bin/opengslb

      # Ensure config permissions
      chmod 600 /etc/opengslb/overwatch.yaml

      # Start service
      echo "Starting service..."
      systemctl daemon-reload
      systemctl enable opengslb-overwatch
      systemctl start opengslb-overwatch

      sleep 3
      systemctl status opengslb-overwatch --no-pager

      echo "=== OpenGSLB Overwatch Setup Completed at $(date) ==="

runcmd:
  - [bash, /opt/setup-opengslb.sh]
