# OpenGSLB Overwatch Configuration Example
# ADR-015: Agent-Overwatch Architecture
#
# Overwatch nodes serve authoritative DNS and:
# - Receive health updates from agents via gossip
# - Perform external validation of agent health claims
# - Operate independently (no cluster coordination)
#
# Usage: opengslb --mode=overwatch --config=/etc/opengslb/overwatch.yaml
#
# Deploy multiple Overwatch nodes and configure clients with all addresses
# in resolv.conf - DNS clients automatically handle failover.

mode: overwatch

overwatch:
  # Identity configuration
  identity:
    node_id: overwatch-us-east-1  # Unique identifier for this node
    region: us-east               # Geographic region

  # Agent authentication tokens
  # Maps service names to their pre-shared tokens
  agent_tokens:
    webapp: "your-secure-service-token-here"
    api: "different-token-for-api-service"
    dbproxy: "another-secure-token"

  # Gossip configuration for receiving agent updates
  gossip:
    bind_address: "0.0.0.0:7946"
    
    # REQUIRED: 32-byte base64-encoded encryption key
    # Generate with: openssl rand -base64 32
    # Must match the key used by agents
    encryption_key: "REPLACE_WITH_YOUR_32_BYTE_BASE64_KEY"
    
    # Timing configuration
    probe_interval: 1s
    probe_timeout: 500ms
    gossip_interval: 200ms

  # External validation settings
  # Overwatch performs its own health checks to validate agent claims
  validation:
    enabled: true
    check_interval: 30s  # How often to validate
    check_timeout: 5s    # Timeout for validation checks

  # Stale backend detection
  stale:
    threshold: 30s   # Mark stale after 30s without heartbeat
    remove_after: 5m # Remove completely after 5 minutes

  # DNSSEC configuration (enabled by default)
  dnssec:
    enabled: true
    algorithm: ECDSAP256SHA256
    key_sync:
      # Other Overwatch nodes for key synchronization
      peers:
        - "https://overwatch-us-east-2.internal:9090"
        - "https://overwatch-eu-west-1.internal:9090"
      poll_interval: 1h
      timeout: 30s

# DNS server configuration
dns:
  listen_address: "0.0.0.0:53"
  default_ttl: 30
  return_last_healthy: false  # Return SERVFAIL when all backends unhealthy
  zones:
    - gslb.example.com
    - internal.example.com

# Regions define the server pools
# In Overwatch mode, these are used for:
# 1. Initial static configuration (before agents register)
# 2. Mapping agent registrations to regions
regions:
  - name: us-east
    servers:
      # Webapp backend servers
      - address: 10.0.1.10
        port: 8080
        weight: 100
        service: webapp.gslb.example.com  # v1.1.0: Required - domain this server belongs to
      - address: 10.0.1.11
        port: 8080
        weight: 100
        service: webapp.gslb.example.com

      # API backend servers
      - address: 10.0.1.20
        port: 8080
        weight: 100
        service: api.gslb.example.com
      - address: 10.0.1.21
        port: 8080
        weight: 100
        service: api.gslb.example.com
    health_check:
      type: http
      interval: 30s
      timeout: 5s
      path: /health
      failure_threshold: 3
      success_threshold: 2

  - name: us-west
    servers:
      # Webapp backend
      - address: 10.0.2.10
        port: 8080
        weight: 100
        service: webapp.gslb.example.com

      # API backend
      - address: 10.0.2.20
        port: 8080
        weight: 100
        service: api.gslb.example.com
    health_check:
      type: http
      interval: 30s
      timeout: 5s
      path: /health
      failure_threshold: 3
      success_threshold: 2

  - name: eu-west
    servers:
      # Webapp backend (API not deployed in EU in this example)
      - address: 10.0.3.10
        port: 8080
        weight: 100
        service: webapp.gslb.example.com
    health_check:
      type: http
      interval: 30s
      timeout: 5s
      path: /health
      failure_threshold: 3
      success_threshold: 2

# Domains define GSLB-managed DNS zones
domains:
  - name: webapp.gslb.example.com
    routing_algorithm: round-robin
    regions:
      - us-east
      - us-west
      - eu-west
    ttl: 30

  - name: api.gslb.example.com
    routing_algorithm: weighted
    regions:
      - us-east
      - us-west
    ttl: 30

  - name: critical.gslb.example.com
    routing_algorithm: failover
    regions:
      - us-east    # Primary
      - us-west    # Secondary
      - eu-west    # Tertiary
    ttl: 15

# Logging configuration
logging:
  level: info
  format: json

# Metrics configuration
metrics:
  enabled: true
  address: ":9090"

# API configuration
api:
  enabled: true
  address: ":9091"
  allowed_networks:
    - 10.0.0.0/8
    - 192.168.0.0/16
    - 127.0.0.1/32
  trust_proxy_headers: false